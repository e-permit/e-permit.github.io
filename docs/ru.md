```markdown
# E-PERMIT

## Введение
E-Permit – это электронная система разрешений, которая обеспечивает цифровое управление разрешениями на международную транспортировку и гарантирует безопасный обмен данными. Каждая страна обменивается информацией о разрешениях стандартизированным и безопасным способом через RESTful API. Этот документ подробно рассматривает установку системы, использование API, вопросы безопасности, аутентификации, целостности данных и управления ошибками.

## Архитектура

Проект E-Permit построен вокруг двух основных API-компонентов: Public API и Internal API. Такое разделение позволяет удовлетворить различные требования в области безопасности и функциональности.

- **Public API:**  
  Этот API, доступный внешнему миру, используется для обмена данными с партнерскими странами. Другие страны могут предоставить свои открытые ключи и отправлять данные о разрешениях или их использовании через Public API. Благодаря цифровым подписям и другим механизмам проверки надежность входящих сообщений обеспечивается. Например, для Турции Public API доступен по адресу [https://disapi.uab.gov.tr/apigateway/e-permit](https://disapi.uab.gov.tr/apigateway/e-permit), где представлена список открытых ключей, подтверждающих идентичность Турции.

- **Internal API:**  
  Этот API предназначен для интеграции с другими системами внутри организации и доступен только локальным системам. Internal API управляет административными и автоматизированными процессами, такими как определение квот, оформление разрешений и их отмена.

- **Синхронизированные базы данных и обмен данными:**  
  Каждое сообщение, отправляемое через оба API, сначала записывается в базу данных отправителя, а затем передается через сервисы, предоставляемые партнерской страной, в их базу данных. Этот механизм обеспечивает синхронизацию данных между странами. Кроме того, целостность сообщений отслеживается с помощью ссылки `previous_event_id`, что гарантирует правильный порядок сообщений и сохранение целостности данных.

Такой архитектурный подход обеспечивает эффективную работу локальных систем и бесперебойный, безопасный и синхронизированный обмен данными между странами.

## Установка и конфигурация

### Исходный код с открытым исходным кодом и Docker-образы
Исходный код системы E-Permit доступен на GitHub как open source. При необходимости:

- **Исходный код:** [e-permit-java GitHub Repository](https://github.com/e-permit/e-permit-java) – Для компиляции проекта требуется JDK (версии 21 или выше) и Maven (версии 3.9.9 или выше). В каталоге проекта можно сгенерировать JAR-файлы, выполнив команду `mvn clean package`.
- **Docker-образы:** 
  - Для Public API: `ghcr.io/e-permit/publicapi:latest`
  - Для Internal API: `ghcr.io/e-permit/internalapi:latest`

Готовые Docker-образы можно использовать вместе с такими инструментами, как Docker Compose, для быстрой установки сервисов.

Каждая страна, использующая приложение e-permit, должна сначала сгенерировать свой собственный приватный ключ, а затем опубликовать его сертификат (открытый ключ) через Public API. На этапе установки система e-permit автоматически создает первоначальный ключ и сохраняет его в базе данных.

## ДЕТАЛИ API

### Public API

Конечные точки Public API предназначены для использования Internal API партнерской страны. Эти конечные точки:

*`/`*  
Каждая страна предоставляет список открытых ключей, подтверждающих её идентичность.

*`/verify/{QR Code}`*  
Обеспечивает проверку электронного транзитного документа, оформленного с помощью QR-кода.

#### События:

*`/events/key-created`*  
С помощью этого метода отправляется сгенерированный открытый ключ в партнерскую страну.

*`/events/key-revoked`*  
С помощью этого метода отправляется отмененный открытый ключ в партнерскую страну.

*`/events/quota-created`*  
С помощью этого метода осуществляется определение квоты для оформления разрешения в партнерскую страну.  
Например, когда Турция назначает квоту для Узбекистана, информация о квоте отправляется через этот метод в Public API Узбекистана.

*`/events/permit-created`*  
Осуществляет отправку оформленного разрешения в партнерскую страну.  
Например, когда Турция оформляет разрешение для своего транспортного средства на основе квоты, определенной Узбекистаном, данные о разрешении передаются через этот метод в Public API Узбекистана.

*`/events/permit-revoked`*  
Осуществляет отправку отмененного разрешения в партнерскую страну.  
Например, когда Турция отменяет разрешение (без передачи информации о его использовании) и затем может оформить новое разрешение, информация об отмененном разрешении отправляется через этот метод в Public API Узбекистана.

*`/events/permit-used`*  
Осуществляет отправку данных об использовании оформленного разрешения с контрольных точек (пограничных переходов) партнерской страны (вход и выход).  
Например, после того как Турция оформляет разрешение для своего транспортного средства на основе квоты, определенной Узбекистаном, и транспортное средство осуществляет вход и выход через пограничные переходы Узбекистана, информация об использовании разрешения передается через этот метод в Public API Турции.

### Internal API

Этот API предназначен для использования собственными системами стран.

Internal API, позволяющий интегрированно управлять квотами и разрешениями совместно с Public API партнерской страны, также опубликован как open source.  
Docker-образ: `ghcr.io/e-permit/internalapi:latest`

### Пример переменных окружения:
```env
SPRING_PROFILES_ACTIVE=dev
HIBERNATE_DDL_AUTO=none
FLYWAY_ENABLED=true
FLYWAY_SCHEMAS=public
SPRING_DATASOURCE_URL=<db url>
SPRING_DATASOURCE_USERNAME=<db user>
SPRING_DATASOURCE_PASSWORD=<db pwd>
SPRING_DATASOURCE_DRIVER=<db driver>
SPRING_DATASOURCE_DIALECT=<dialect>
EPERMIT_ISSUER_CODE=<Country code>
EPERMIT_ISSUER_NAME=<Country name>
EPERMIT_ADMIN_PASSWORD=<admin pwd>
EPERMIT_KEY_PASSWORD=<admin pwd for encrypting key>
EPERMIT_LOG_BASEPATH=<log base path e.g /var/log/epermit>
```

Например, как Турция, мы используем как open source Public API, так и Internal API. Вместо того чтобы напрямую обращаться к Public API партнерской страны для интеграции с другими нашими внутренними приложениями (e-государство, unet, gebos, таможенные службы и т.д.), мы интегрируем систему e-permit через Internal API, который выполняет роль прокси, обеспечивая более устойчивую интеграцию.

#### Функции Internal API:

**Рукопожатие (определение страны):**  
Для представления цифровых идентичностей стран друг другу на первом этапе выполняется процесс рукопожатия (регистрация ключа). Например, как Турция, на основании двустороннего соглашения с Узбекистаном для интеграции узбекской системы e-permit, отправляется POST-запрос по адресу `/authorities` со следующим содержимым:

```json
{
  "api_uri": "http://uz-public-api"
}
```

Значение `api_uri` — это адрес сервиса Public API, предоставляемый страной, с которой заключено соглашение. Используя подробную информацию, размещенную по этому адресу, система e-permit выполняет определение страны. Узбекистан должен выполнить аналогичные действия для интеграции Турции в свою систему e-permit.

**Определение квоты:**  
Это процесс выделения квоты для распределения транзитных разрешений партнерской стране по соглашению. Например, Турция выделяет квоту транзитных разрешений для узбекских перевозчиков. Типы документов следующие:
`BILATERAL`, `TRANSIT`, `THIRDCOUNTRY`, `BILATERAL_FEE`, `TRANSIT_FEE`, `THIRDCOUNTRY_FEE`

Отправляется POST-запрос по адресу `/authority_quotas` со следующим содержимым:
```json
{
    "authority_code": "UZ",
    "permit_type": "BILATERAL",
    "permit_year": 2024,
    "start_number": 1,
    "end_number": 250
}
```
Этот POST-запрос передается через Internal API в Public API партнерской страны по адресу `/events/quota-created`. Если сообщение не может быть доставлено немедленно, оно ставится в очередь и отправляется автоматически в фоновом режиме.

**Оформление транзитного разрешения:**  
Это процесс оформления электронного транзитного разрешения для перевозчиков на основе квоты, определенной партнерской страной. Например, Турция может оформить электронное транзитное разрешение для турецких перевозчиков с использованием квоты, определенной Узбекистаном, как показано в следующем примере. Отправляется POST-запрос по адресу `/permits` со следующим содержимым:
```json
{
    "issued_for": "UZ",
    "permit_year": 2024,
    "permit_type": "BILATERAL",
    "company_name": "TECT",
    "company_id": "123",
    "plate_number": "TECT"
}
```
Этот POST-запрос передается через Internal API в Public API партнерской страны по адресу `/events/permit-created`. Если сообщение не может быть доставлено немедленно, оно ставится в очередь и отправляется автоматически в фоновом режиме.

**Отмена транзитного разрешения:**  
Если оформленное электронное транзитное разрешение требуется отменить страной, которая его оформила, и информация об использовании (вход/выход) не была получена от партнерской страны, отмена может быть выполнена с помощью данного метода с последующим уведомлением партнерской страны.

Например, Турция может отправить уведомление об отмене для транзитного разрешения, для которого не была получена информация об использовании. Отправляется DELETE-запрос по адресу `/permits/{permit-id}`, например: `/permits/TR-UZ-2022-1-2`.

DELETE-запрос передается через Internal API в Public API партнерской страны по адресу `/events/permit-revoked`. Если сообщение не может быть доставлено немедленно, оно ставится в очередь и отправляется автоматически в фоновом режиме.

**Операции по передаче информации об использовании транзитного разрешения (вход/выход):**  
Когда перевозчик с электронным документом входит или выходит в/из целевой страны, информация о входе/выходе транзитного разрешения должна быть передана в систему e-permit страны-перевозчика.

*`/permits/{permit_id}/activities`*

Пример: `permits/TR-UZ-2022-1-1/activities`  
Пример запроса уведомления о входе:
```json
{
    "activity_type": "ENTRANCE",
    "activity_timestamp": 1656406166,
    "activity_details": "Информация о входном пункте"
}
```
Пример запроса уведомления о выходе:
```json
{
    "activity_type": "EXIT",
    "activity_timestamp": 1656406166,
    "activity_details": "Информация о выходном пункте"
}
```
Этот POST-запрос передается через Internal API в Public API партнерской страны по адресу `/events/permit-used`. Если сообщение не может быть доставлено немедленно, оно ставится в очередь и отправляется автоматически в фоновом режиме.

## Коды ошибок и их описание:
```
Структура ответа:
• 401 для недействительного JWS
• 400 для некорректного запроса
• 200 для успешного выполнения
• 422
```

```json
{
  "error_code": " (см. коды ошибок ниже) ",
  "error_message": " сообщение об ошибке "
}
```

```
Коды ошибок:
    AUTHORITY_ALREADY_EXISTS: Страна, которую пытаются зарегистрировать, уже существует.
    AUTHORITY_NOT_FOUND: Операция выполняется без предварительного определения партнерской страны.
    EVENT_ALREADY_EXISTS: Попытка повторной отправки уже отправленного события.
    PREVIOUS_EVENT_NOTFOUND: Нарушение синхронизации цепочки событий между странами.
    GENESIS_EVENT_ALREADY_EXISTS: Попытка повторного создания начального события.
    KEYID_ALREADY_EXISTS: Регистрируемый идентификатор ключа уже существует.
    KEY_NOTFOUND: Ключ не найден при проверке подписанного события.
    INSUFFICIENT_KEY: При удалении ключа не остается ни одного определения.
    INSUFFICIENT_PERMIT_QUOTA: Недостаточная квота для оформления транзитного разрешения.
    INVALID_QUOTA_INTERVAL: Серийный номер квоты находится вне допустимого диапазона.
    PERMITID_ALREADY_EXISTS: Транзитное разрешение с таким же серийным номером уже существует.
    PERMIT_NOTFOUND: Транзитное разрешение, по которому производится операция, не найдено.
    PERMIT_USED: Транзитное разрешение, которое пытаются отменить, уже использовано.
    INVALID_PERMITID: Неверный номер разрешения.
```
```
